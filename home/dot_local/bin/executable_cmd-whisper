#!/usr/bin/env bash

WAVFILE="/tmp/whisper-recording.wav"
MODEL="/usr/share/whisper.cpp-model-large-v3-turbo/ggml-large-v3-turbo.bin"
LOCKFILE="/tmp/whisper-recording.lock"

# Prevent multiple instances
if [ -f "$LOCKFILE" ]; then
    exit 0
fi
touch "$LOCKFILE"
trap 'rm -f "$LOCKFILE" "$WAVFILE"' EXIT

notify-send -e "Whisper" "Listening..." -t 2000

# Record until 3.5s of silence is detected
rec -r 16000 -c 1 -b 16 "$WAVFILE" silence 1 0.1 3% 1 3.5 3%

notify-send -e "Whisper" "Transcribing..." -t 2000

text=$(whisper-cli -m "$MODEL" -nt -np -f "$WAVFILE" 2>/dev/null | sed '/^$/d' | sed 's/^ *//g')

if [ -n "$text" ]; then
    echo -n "$text" | wl-copy
    wtype -- "$text"
else
    notify-send -e "Whisper" "No speech detected" -t 2000
fi
